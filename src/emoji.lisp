(in-package #:clabber)

;;; Emoji shortcode expansion
;;; Converts :shortcode: patterns to Unicode emoji characters

(defvar *emoji-table* (make-hash-table :test 'equal))

(defun init-emoji-table ()
  "Initialize the emoji shortcode lookup table."
  (clrhash *emoji-table*)
  (loop for (code . emoji) in
        '(;; Smileys & People
          ("smile" . "ğŸ˜„") ("laughing" . "ğŸ˜†") ("blush" . "ğŸ˜Š")
          ("smiley" . "ğŸ˜ƒ") ("grinning" . "ğŸ˜€") ("grin" . "ğŸ˜")
          ("joy" . "ğŸ˜‚") ("rofl" . "ğŸ¤£") ("relaxed" . "â˜ºï¸")
          ("wink" . "ğŸ˜‰") ("kiss" . "ğŸ’‹") ("kissing" . "ï¿½ğŸ˜—") ("kissing_heart" . "ğŸ˜˜")
          ("kissing_closed_eyes" . "ğŸ˜š") ("kissing_smiling_eyes" . "ğŸ˜™")
          ("heart_eyes" . "ğŸ˜")
          ("yum" . "ğŸ˜‹") ("stuck_out_tongue" . "ğŸ˜›")
          ("stuck_out_tongue_winking_eye" . "ğŸ˜œ")
          ("stuck_out_tongue_closed_eyes" . "ğŸ˜")
          ("sunglasses" . "ğŸ˜") ("smirk" . "ğŸ˜")
          ("unamused" . "ğŸ˜’") ("disappointed" . "ğŸ˜") ("pensive" . "ğŸ˜”")
          ("worried" . "ğŸ˜Ÿ") ("confused" . "ğŸ˜•") ("slightly_frowning_face" . "ğŸ™")
          ("frowning" . "ğŸ˜¦") ("persevere" . "ğŸ˜£") ("confounded" . "ğŸ˜–")
          ("tired_face" . "ğŸ˜«") ("weary" . "ğŸ˜©") ("cry" . "ğŸ˜¢")
          ("sob" . "ğŸ˜­") ("triumph" . "ğŸ˜¤") ("angry" . "ğŸ˜ ")
          ("rage" . "ğŸ˜¡") ("no_mouth" . "ğŸ˜¶") ("neutral_face" . "ğŸ˜")
          ("expressionless" . "ğŸ˜‘") ("hushed" . "ğŸ˜¯") ("flushed" . "ğŸ˜³")
          ("astonished" . "ğŸ˜²") ("open_mouth" . "ğŸ˜®") ("scream" . "ğŸ˜±")
          ("fearful" . "ğŸ˜¨") ("cold_sweat" . "ğŸ˜°") ("sweat" . "ğŸ˜“")
          ("sleeping" . "ğŸ˜´") ("dizzy_face" . "ğŸ˜µ") ("thinking" . "ğŸ¤”")
          ("lying_face" . "ğŸ¤¥") ("zipper_mouth" . "ğŸ¤")
          ("nerd" . "ğŸ¤“") ("cowboy" . "ğŸ¤ ") ("clown" . "ğŸ¤¡")
          ("mask" . "ğŸ˜·") ("thermometer_face" . "ğŸ¤’")
          ("skull" . "ğŸ’€") ("ghost" . "ğŸ‘»") ("alien" . "ğŸ‘½")
          ("robot" . "ğŸ¤–") ("poop" . "ğŸ’©") ("hankey" . "ğŸ’©")
          ("imp" . "ğŸ˜ˆ") ("devil" . "ğŸ‘¿") ("japanese_ogre" . "ğŸ‘¹")
          ;; Gestures
          ("thumbsup" . "ğŸ‘") ("+1" . "ğŸ‘") ("thumbsdown" . "ğŸ‘")
          ("-1" . "ğŸ‘") ("ok_hand" . "ğŸ‘Œ") ("punch" . "ğŸ‘Š")
          ("fist" . "âœŠ") ("wave" . "ğŸ‘‹") ("clap" . "ğŸ‘")
          ("raised_hands" . "ğŸ™Œ") ("pray" . "ğŸ™") ("handshake" . "ğŸ¤")
          ("point_up" . "â˜ï¸") ("point_down" . "ğŸ‘‡")
          ("point_left" . "ğŸ‘ˆ") ("point_right" . "ğŸ‘‰")
          ("middle_finger" . "ğŸ–•") ("muscle" . "ğŸ’ª")
          ;; Hearts & Symbols
          ("heart" . "â¤ï¸") ("orange_heart" . "ğŸ§¡") ("yellow_heart" . "ğŸ’›")
          ("green_heart" . "ğŸ’š") ("blue_heart" . "ğŸ’™") ("purple_heart" . "ğŸ’œ")
          ("black_heart" . "ğŸ–¤") ("broken_heart" . "ğŸ’”")
          ("sparkling_heart" . "ğŸ’–") ("heartpulse" . "ğŸ’—")
          ("heartbeat" . "ğŸ’“") ("two_hearts" . "ğŸ’•")
          ("revolving_hearts" . "ğŸ’") ("cupid" . "ğŸ’˜")
          ("gift_heart" . "ğŸ’") ("heart_exclamation" . "â£ï¸")
          ("100" . "ğŸ’¯") ("fire" . "ğŸ”¥") ("star" . "â­")
          ("star2" . "ğŸŒŸ") ("sparkles" . "âœ¨") ("zap" . "âš¡")
          ("boom" . "ğŸ’¥") ("collision" . "ğŸ’¥") ("sweat_drops" . "ğŸ’¦")
          ("dash" . "ğŸ’¨") ("hole" . "ğŸ•³ï¸") ("bomb" . "ğŸ’£")
          ("speech_balloon" . "ğŸ’¬") ("thought_balloon" . "ğŸ’­")
          ("zzz" . "ğŸ’¤") ("wave_dash" . "ã€°ï¸")
          ;; Animals
          ("dog" . "ğŸ¶") ("cat" . "ğŸ±") ("mouse" . "ğŸ­")
          ("hamster" . "ğŸ¹") ("rabbit" . "ğŸ°") ("fox" . "ğŸ¦Š")
          ("bear" . "ğŸ»") ("panda" . "ğŸ¼") ("koala" . "ğŸ¨")
          ("tiger" . "ğŸ¯") ("lion" . "ğŸ¦") ("cow" . "ğŸ®")
          ("pig" . "ğŸ·") ("frog" . "ğŸ¸") ("monkey" . "ğŸµ")
          ("chicken" . "ğŸ”") ("penguin" . "ğŸ§") ("bird" . "ğŸ¦")
          ("eagle" . "ğŸ¦…") ("owl" . "ğŸ¦‰") ("bat" . "ğŸ¦‡")
          ("wolf" . "ğŸº") ("horse" . "ğŸ´") ("unicorn" . "ğŸ¦„")
          ("bee" . "ğŸ") ("bug" . "ğŸ›") ("butterfly" . "ğŸ¦‹")
          ("snail" . "ğŸŒ") ("octopus" . "ğŸ™") ("turtle" . "ğŸ¢")
          ("snake" . "ğŸ") ("shark" . "ğŸ¦ˆ") ("whale" . "ğŸ³")
          ("dolphin" . "ğŸ¬") ("fish" . "ğŸŸ") ("crab" . "ğŸ¦€")
          ("shrimp" . "ğŸ¦") ("squid" . "ğŸ¦‘") ("dragon" . "ğŸ‰")
          ;; Food & Drink
          ("apple" . "ğŸ") ("green_apple" . "ğŸ") ("pear" . "ğŸ")
          ("orange" . "ğŸŠ") ("lemon" . "ğŸ‹") ("banana" . "ğŸŒ")
          ("watermelon" . "ğŸ‰") ("grapes" . "ğŸ‡") ("strawberry" . "ğŸ“")
          ("peach" . "ğŸ‘") ("cherries" . "ğŸ’") ("pizza" . "ğŸ•")
          ("hamburger" . "ğŸ”") ("fries" . "ğŸŸ") ("hotdog" . "ğŸŒ­")
          ("taco" . "ğŸŒ®") ("burrito" . "ğŸŒ¯") ("egg" . "ğŸ¥š")
          ("coffee" . "â˜•") ("tea" . "ğŸµ") ("beer" . "ğŸº")
          ("beers" . "ğŸ»") ("wine_glass" . "ğŸ·") ("cocktail" . "ğŸ¸")
          ("tropical_drink" . "ğŸ¹") ("champagne" . "ğŸ¾")
          ("cake" . "ğŸ‚") ("cookie" . "ğŸª") ("chocolate_bar" . "ğŸ«")
          ("candy" . "ğŸ¬") ("lollipop" . "ğŸ­") ("ice_cream" . "ğŸ¨")
          ("doughnut" . "ğŸ©") ("popcorn" . "ğŸ¿")
          ;; Activities & Objects
          ("soccer" . "âš½") ("basketball" . "ğŸ€") ("football" . "ğŸˆ")
          ("baseball" . "âš¾") ("tennis" . "ğŸ¾") ("trophy" . "ğŸ†")
          ("medal" . "ğŸ…") ("guitar" . "ğŸ¸") ("microphone" . "ğŸ¤")
          ("headphones" . "ğŸ§") ("video_game" . "ğŸ®") ("joystick" . "ğŸ•¹ï¸")
          ("dart" . "ğŸ¯") ("dice" . "ğŸ²") ("musical_note" . "ğŸµ")
          ("notes" . "ğŸ¶") ("art" . "ğŸ¨") ("movie_camera" . "ğŸ¥")
          ("camera" . "ğŸ“·") ("tv" . "ğŸ“º") ("computer" . "ğŸ’»")
          ("keyboard" . "âŒ¨ï¸") ("phone" . "ğŸ“±") ("email" . "ğŸ“§")
          ("mailbox" . "ğŸ“«") ("package" . "ğŸ“¦") ("pencil" . "âœï¸")
          ("memo" . "ğŸ“") ("book" . "ğŸ“–") ("books" . "ğŸ“š")
          ("link" . "ğŸ”—") ("paperclip" . "ğŸ“") ("scissors" . "âœ‚ï¸")
          ("lock" . "ğŸ”’") ("unlock" . "ğŸ”“") ("key" . "ğŸ”‘")
          ("hammer" . "ğŸ”¨") ("wrench" . "ğŸ”§") ("gear" . "âš™ï¸")
          ("bulb" . "ğŸ’¡") ("flashlight" . "ğŸ”¦") ("mag" . "ğŸ”")
          ;; Nature & Weather
          ("sunny" . "â˜€ï¸") ("cloud" . "â˜ï¸") ("umbrella" . "â˜‚ï¸")
          ("snowflake" . "â„ï¸") ("rainbow" . "ğŸŒˆ") ("ocean" . "ğŸŒŠ")
          ("earth" . "ğŸŒ") ("volcano" . "ğŸŒ‹") ("milky_way" . "ğŸŒŒ")
          ("crescent_moon" . "ğŸŒ™") ("full_moon" . "ğŸŒ•")
          ("sun_with_face" . "ğŸŒ") ("moon_face" . "ğŸŒ")
          ("fallen_leaf" . "ğŸ‚") ("maple_leaf" . "ğŸ")
          ("four_leaf_clover" . "ğŸ€") ("herb" . "ğŸŒ¿")
          ("cactus" . "ğŸŒµ") ("palm_tree" . "ğŸŒ´") ("evergreen_tree" . "ğŸŒ²")
          ("rose" . "ğŸŒ¹") ("sunflower" . "ğŸŒ»") ("tulip" . "ğŸŒ·")
          ("cherry_blossom" . "ğŸŒ¸") ("bouquet" . "ğŸ’")
          ("mushroom" . "ğŸ„") ("chestnut" . "ğŸŒ°")
          ;; Flags & Misc
          ("checkered_flag" . "ğŸ") ("triangular_flag" . "ğŸš©")
          ("white_flag" . "ğŸ³ï¸") ("rainbow_flag" . "ğŸ³ï¸â€ğŸŒˆ")
          ("pirate_flag" . "ğŸ´â€â˜ ï¸")
          ("warning" . "âš ï¸") ("no_entry" . "â›”")
          ("x" . "âŒ") ("o" . "â­•") ("bangbang" . "â€¼ï¸")
          ("question" . "â“") ("exclamation" . "â—")
          ("white_check_mark" . "âœ…") ("heavy_check_mark" . "âœ”ï¸")
          ("ballot_box_with_check" . "â˜‘ï¸")
          ("recycle" . "â™»ï¸") ("copyright" . "Â©ï¸") ("registered" . "Â®ï¸")
          ("tm" . "â„¢ï¸") ("infinity" . "â™¾ï¸")
          ;; Faces extras
          ("eyes" . "ğŸ‘€") ("eye" . "ğŸ‘ï¸") ("tongue" . "ğŸ‘…")
          ("lips" . "ğŸ‘„") ("brain" . "ğŸ§ ") ("bone" . "ğŸ¦´")
          ;; Tech / Dev
          ("rocket" . "ğŸš€") ("satellite" . "ğŸ›°ï¸") ("flying_saucer" . "ğŸ›¸")
          ("shield" . "ğŸ›¡ï¸") ("crossed_swords" . "âš”ï¸")
          ("skull_crossbones" . "â˜ ï¸") ("radioactive" . "â˜¢ï¸")
          ("biohazard" . "â˜£ï¸") ("atom" . "âš›ï¸")
          ;; Common chat
          ("thumbs_up" . "ğŸ‘") ("thumbs_down" . "ğŸ‘")
          ("ok" . "ğŸ‘Œ") ("v" . "âœŒï¸") ("peace" . "âœŒï¸")
          ("shrug" . "ğŸ¤·") ("facepalm" . "ğŸ¤¦")
          ("party" . "ğŸ‰") ("tada" . "ğŸ‰") ("confetti" . "ğŸŠ")
          ("balloon" . "ğŸˆ") ("gift" . "ğŸ") ("ribbon" . "ğŸ€")
          ("crown" . "ğŸ‘‘") ("gem" . "ğŸ’") ("ring" . "ğŸ’")
          ("money" . "ğŸ’°") ("dollar" . "ğŸ’µ") ("moneybag" . "ğŸ’°")
          ("chart" . "ğŸ“ˆ") ("chart_down" . "ğŸ“‰")
          ("bell" . "ğŸ””") ("no_bell" . "ğŸ”•")
          ("mega" . "ğŸ“£") ("loudspeaker" . "ğŸ“¢")
          ("pin" . "ğŸ“Œ") ("pushpin" . "ğŸ“")
          ("flag" . "ğŸš©") ("checkmark" . "âœ…")
          ("cross" . "âŒ") ("stop" . "ğŸ›‘")
          ("sos" . "ğŸ†˜") ("new" . "ğŸ†•") ("free" . "ğŸ†“")
          ("up" . "ğŸ†™") ("cool" . "ğŸ†’") ("ng" . "ğŸ†–")
          ;; Lisp / Hacker
          ("lambda" . "Î»") ("lisp" . "Î»") ("parens" . "()")
          ("hacker" . "ğŸ‘¨â€ğŸ’»") ("woman_technologist" . "ğŸ‘©â€ğŸ’»"))
        do (setf (gethash code *emoji-table*) emoji)))

(defun emoji-expand (text)
  "Replace :shortcode: patterns in TEXT with their emoji equivalents."
  (let ((result (make-array (length text) :element-type 'character
                            :adjustable t :fill-pointer 0))
        (i 0)
        (len (length text)))
    (loop while (< i len)
          do (if (char= (char text i) #\:)
                 ;; Look for closing :
                 (let ((end (position #\: text :start (1+ i))))
                   (if (and end (> end (1+ i))
                            ;; No spaces inside shortcode
                            (not (position #\Space text :start (1+ i) :end end)))
                       (let* ((code (subseq text (1+ i) end))
                              (emoji (gethash code *emoji-table*)))
                         (if emoji
                             (progn
                               (loop for c across emoji
                                     do (vector-push-extend c result))
                               (setf i (1+ end)))
                             ;; Not a known shortcode, keep the :
                             (progn
                               (vector-push-extend #\: result)
                               (incf i))))
                       ;; No closing : or empty, keep the :
                       (progn
                         (vector-push-extend #\: result)
                         (incf i))))
                 (progn
                   (vector-push-extend (char text i) result)
                   (incf i))))
    (coerce result 'string)))

(defun emoji-complete (prefix)
  "Return list of (code . emoji) pairs matching PREFIX, sorted by code."
  (let ((matches nil))
    (maphash (lambda (code emoji)
               (when (and (>= (length code) (length prefix))
                          (string= prefix code :end2 (length prefix)))
                 (push (cons code emoji) matches)))
             *emoji-table*)
    (sort matches #'string< :key #'car)))

;; Initialize on load
(init-emoji-table)
